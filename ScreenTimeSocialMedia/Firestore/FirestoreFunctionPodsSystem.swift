//
//  FirestoreFunctionPodsSystem.swift
//  ScreenTimeSocialMedia
//
//  Created by Andrew Kuznetsov on 10/5/23.
//

import Foundation
import FirebaseFirestore

extension FirestoreFunctions {
    // stores a "Pod" in firestore based on passed on Pod Model
    func createPod(pod: Pods) {
        let docRef = PODS_REF.addDocument(data: [
            "title": pod.title!,
            "podType": pod.podType.rawValue,
            "currentStrikes": 0,
            "totalStrikes": pod.totalStrikes!,
            "timeframe": pod.timeframe!,
            "owner": CURRENT_USER_UID
        ]) { error in
            if let error = error {
                print("Error adding pod: \(error)")
                return
            }
        }

        let generatedPodID = docRef.documentID // gets podID generated by firestore
        
        // Update the user's podIDs list
        self.CURRENT_USER_REF.updateData(["podIDs": FieldValue.arrayUnion([generatedPodID])]) { error in
            if let error = error {
                print("Error adding pod to podIDs list for Current User: \(error)")
            }
        }

        // Add the current user to the list of pod users
        self.addUserToPod(podID: generatedPodID, user: User(username: self.CURRENT_USER_USERNAME, userID: self.CURRENT_USER_UID))
    }
    
    /*func addPodMessages(pod: Pods, message: Messages) {
        PODS_REF.document(pod.podID).collection("messages").addDocument(data:[
            "from": message.from,
            "text": message.text,
            "timeStamp": Timestamp(date: Date())
        ]) { err in
            if let _ = err {
                print("error adding message")
            } else {
                print("message added sucessfully")
            }
        }
    }*/
    
    // with a given Pod instance add a User to the instance
    func addUserToPod(podID: String, user: User) {
        // save user uid and username in pod instance document
        PODS_REF.document(podID).collection("users").document(user.uid).setData(["username": user.username!]) { err in
            if let err = err {
                print("error adding user to pod: \(err)")
            }
        }
    }
}
